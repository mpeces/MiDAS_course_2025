---
title: "mca24"
author: "Miriam Peces, Marta Nierychlo, Kasper S. Andersen"
date: "`r format(Sys.time(), '%Y-%m-%d')`, Aalborg, Denmark"
output: html_document
---

>Note: This is an R markdown report see this [cheat sheet](https://goo.gl/QM4Psf) for more information on how to make nice Rmarkdown documents.

## Background to the project
The dataset contains timeseries data from 4 Danish Wastewater Treatment Plants (WWTPs) from year 2020 collected in the frame of [MiDAS project](https://midasfieldguide.org/danish).

## Install ampvis2
Installation instructions and guides for `ampvis2` can be found on [the associated homepage](https://kasperskytte.github.io/ampvis2/articles/ampvis2.html). If you need to install it, please execute the code from the first chunk below (for windows users you need to start Rstudio as administrator). 

Note: `eval=F` in the `code chunk` header means that it is not evaluated (run) when the html is build.
```{r, eval = F}
#install.packages("remotes")
#remotes::install_github("kasperskytte/ampvis2")
```


## Load the packages
Remember to load the packages before you try to use the associated functions.
```{r, warning = F, message=F}
library(ampvis2)
library(tidyverse)
```


## set working directory
```{r}
setwd("C:/Users/miria/OneDrive - Aalborg Universitet/Aalborg/9. Teaching/teaching 2024-09-12")
```


## Load the data into R
We first load the raw ASV-table. It contains the ASV ID (e.g. "ASV15", even though the column name says OTU, it contain ASVs), which can be linked to the original DNA sequence; the sample-identifier (e.g. "MQ202218-151"); the number of reads associated to each ASV in each sample (e.g. "ASV1" is seen 127 times in sample "MQ201118-151"). Finally, the last 7 columns contain the taxonomic information - where each bacteria was classified from Kingdom to Species using WWTP ecosystem-specific MiDAS taxonomy. Here only genus-level taxonomy is shown.
```{r, message = F}
asvtable <- read_delim(file = "data/mca24_asvtable.tsv", delim = "\t")
asvtable[c(2,4,5), c(1,2,3,168)]
```


We also load the metadata which contains information on each sample. Note that the **Sample** is what connects your metadata to your ASV-table.
```{r}
metadata <- read.delim("data/mca24_metadata.txt")
head(metadata)
```


## Combine to an ampvis2 object
To make the analysis easy the metadata and asvtable is combined into a single object `d`. You could name it however you like. I just like to keep short names.
```{r}
d <- amp_load(otutable = asvtable, metadata = metadata)
```


# Basic QC analysis
Evaluation of negative controls: as we often work with tiny amounts of DNA contamination often occur. This could be from other samples, yourself and even the kits/reagents we use. Hence, it is important to take a critical look at the negative controls compared to the real samples. However, in the interest of time you can assume that problematic samples have been removed from the data set.

## Rarefaction curves
The goal of this analysis is to evaluate if we have sequenced enough reads pr. sample to represent the diversity in the samples. This is often a subjective decision. For every sample, we take 1 read at a time, and evaluate if this belongs to an ASV we have already observed, or if this read represents new diversity (and ASV that has not been observed before). Every time we evaluate a new read we move 1 point on the x-axis and if it is a new ASV we also move 1 point up on the y-axis. When the curve is steep we discover new ASVs often, indicating that we need to sequence more reads to capture the diversity in the sample. When the curve flattens, we rarely observe new ASVs, indicating that we have captured most of the diversity in the sample. Often you have to compromise with the number of reads in order to keep more samples in your analysis.
```{r, warning=F, fig.align='center'}
amp_rarecurve(data = d, 
              color_by = "Plant", 
              stepsize = 1000)
```


The function `amp_alphadiv` takes the metadata and appends the number of reads and ASVs in each sample which then can be used for further analysis. 
```{r}
stats <- amp_alphadiv(data = d)
```


## Check the number of reads produced pr. sample.

>Note: You can use "+" to modify all ampvis2 plots as behind the surface they are just ggplot2 objects. Here we change a number of features (e.g. y axis title or x axis label position).

```{r, fig.align='center'}
ggplot(stats, aes(x = Sample, y = Reads, color = Plant)) +
  geom_jitter(width = 0.1) +
  ylab("Number of reads") +
  theme_classic() +
  theme(panel.grid.major = element_line(color = "grey90"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = c(1000,5000,10000,50000,100000, 150000), limits = c(1,150000))
```


## Subset to a miminum number of reads per sample
After we have decided that we don't trust that samples with less than 10000 we remove them from our analysis. We store the subset in the object "ds".
```{r, warning = F}
ds <- amp_subset_samples(data = d, minreads = 10000)

amp_rarecurve(data = ds, 
              color_by = "Plant", 
              stepsize = 1000) + 
  xlim(0,100000) +
  ylim(0,10000) +
  geom_vline(xintercept=10000, color = "darkred", lty = 2) +
  scale_color_discrete(name = "") +
  theme(legend.position = c(0.1, 0.9))
```


## Normalize the data to relative abundances
```{r}
dn <- amp_subset_samples(ds, normalise = TRUE)
```


# Metadata overview
First, it is essential that you get an overview of the samples you are looking at. E.g. how many samples are there from each plant and what type of information do we have. You can access the metadata of the samples in your ampvis2 object using the following:
```{r}
dn$metadata %>% head()
```


## Create a new column in the metadata with the `Month` information (as a character) based on the `Date` column. 
```{r}
dn$metadata$Month <- as.character(format(as.Date(dn$metadata$Date),'%m'))
```


## Count the number of samples per plant
Use the function `count()` from the tidyverse package to summarize how many samples were taken at each WWTP as a simple table. You could also visualize it using e.g. `geom_col()` or `geom_bar()` from the ggplot2 package.
```{r}
#calculate 
dn$metadata %>%
  group_by(Plant) %>%
  count()

#using geom_col
dn$metadata %>%
  group_by(Plant) %>%
  count() %>% 
  ggplot(aes(x = Plant,
             y = n,
             fill = Plant)) +
  geom_col()

#using geom_bar
dn$metadata %>%
  ggplot() +
  geom_bar(aes(Plant, fill = Plant), stat = "count")
```


# Data analysis

## 1. Which are the 25 most abundant genera in each Plant?
We normally start data analysis by making overview using the `amp_heatmap()` function. Modify the heatmap below using the relevant options - inspirations can be found in the [Get started](https://kasperskytte.github.io/ampvis2/articles/ampvis2.html) guide.
```{r}
amp_heatmap(data = dn,
            group_by = "Month",
            tax_aggregate = "Genus",
            normalise = FALSE,
            facet_by = "Plant",
            tax_show = 25,
            plot_values_size = 3)
```


## 2. Alpha diversity
In microbial community analysis we often also quantify the diversity of the community in any single sample. This can be quantified with a single number that takes into account the number and abundance of the individual taxa. There are numerous ways of calculating these `diversity indices`, and many can be calculated using the `amp_alpha_diversity()` function. The results are appended to the end of metadata as simple columns.
```{r}
alpha <- amp_alpha_diversity(data = ds)
head(alpha)
```

Plot the species richness - `ObservedOTUs` and Shannon diversity of the `alpha` data set using the `geom_boxplot()` from the ggplot2 package. See e.g. [this example](http://www.sthda.com/english/wiki/ggplot2-box-plot-quick-start-guide-r-software-and-data-visualization).
In which plant the microbial community is least diverse?
```{r}
ggplot(alpha, aes(Plant, uniqueOTUs, color = Plant)) +
  geom_boxplot()

ggplot(alpha, aes(Plant, Shannon, color = Plant)) +
  geom_boxplot()
```


## 3. Beta diversity
When we are comparing between samples we call it beta-diversity. One of the most common ways or comparing large data sets and identify similarities and differences are using ordination. See [this guide](http://albertsenlab.org/ampvis2-ordination/) for an introduction to the topic.
Ordination is trying to show you the largest differences between samples. In ordination we take the ASV table with 1000's of bacteria and try to visualize which samples have similar microbial communities. Samples (colored dots) located close together have similar microbial communities, while samples located far apart have different microbial communities. There are many versions of the ordination. One of the most simple and commonly used is `PCA` where the raw ASV counts are often transformed using `hellinger` transformation that takes the square root of the relative abundance. See [this guide](https://sites.google.com/site/mb3gustame/reference/data-transformations) for short intro on `Hellinger` and other data tranformations. In addition to transforming the data, different types of ordination can be made (PCoA or NMDS are also often used).

What can you say about the similarity of microbial communities in the 4 WWTPs based on PCA plot?
```{r}
amp_ordinate(data = dn, 
             transform = "Hellinger", 
             type = "PCA",
             sample_color_by = "Plant"
             )
```

Check which bacteria are mainly causing the differences among the observed clusters (by using `species_nlabels` and `species_label_taxonomy`). Can you relate the ordination results to your `heatmap`?
```{r}
amp_ordinate(data = dn, 
             transform = "Hellinger", 
             type = "PCA",
             sample_color_by = "Plant",
             species_plot = FALSE,
             species_nlabels = 10,
             species_label_taxonomy = "Genus")
```






# Additonal tasks
1. Identify the outlier (by e.g. using amp_ordination & sample_label_by option or amp_heatmap & adjusting the "Group_by" parameter to show the "Sample"), subset the dataset to remove the outlier sample and replot the ordination and heatmap.

2. Make 2 PCA plots for Kalundborg and Ribe using `sample_trajectory` option to see the changes in the community over time. Comment on the stability of the communities in the two WWTPs. What do you think may cause the progression of the communities that you see on the plot?
```{r}
dn$metadata$Date <- as.Date(dn$metadata$Date)
ribe <- amp_subset_samples(dn, Plant == "Ribe")

amp_ordinate(ribe,
  type = "pca",
  transform = "Hellinger",
  sample_color_by = "Date",
  sample_colorframe_label = "Plant", 
  sample_trajectory = "Date", 
  sample_trajectory_group = "Plant",
  sample_label_by = "Month"
)

kal <- amp_subset_samples(dn, Plant == "Kalundborg")

amp_ordinate(kal,
  type = "pca",
  transform = "Hellinger",
  sample_color_by = "Date",
  sample_colorframe_label = "Plant", 
  sample_trajectory = "Date", 
  sample_trajectory_group = "Plant",
  sample_label_by = "Month"
)
```

3. Subset the `Tetrasphaera` genus data from Ribe WWTP using `amp_subset_taxa()` and `amp_timeseries()` functions; and plot the data to identify which month the abundance of `Tetrasphaera` was the highest. 
```{r} 
subset <- amp_subset_taxa(data = dn, tax_vector = "g__Tetrasphaera") %>% 
  amp_subset_samples(Plant == "Ribe")
  
amp_time_series(subset,
                time_variable = "Date", 
                tax_aggregate = "Genus",
                normalise = FALSE)
```

4. Subset the data for Lynetten and plot the heatmap showing the 25 most abundant genera. The `amp_heatmap` function offers the possibility of directly linking the genus-level plot with functional information from [midas field guide](https://midasfieldguide.org/guide/search). To do that, use:

option plot_functions = TRUE
functions = c("Filamentous", "AOB", "NOB", "PAO", "GAO")

How many of the genera have the functional information available?
What is the function of the most abundant bacteria in this WWTP?
```{r}
lyn <- amp_subset_samples(dn, Plant == "Lynetten")
amp_heatmap(data = lyn,
            tax_aggregate = "Genus",
            normalise = FALSE,
            group_by = "Month",
            facet_by = "Plant",
            tax_show = 25,
            plot_functions = TRUE,
            functions = c("Filamentous", "AOB", "NOB", "PAO", "GAO"))

```

